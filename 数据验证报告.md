# 数据验证报告

## ✅ 验证结果：通过

您在 `data/ticks/` 文件夹中放置的Parquet分区数据已成功验证并可以使用！

---

## 📊 数据概况

### 可用品种
- ✅ BTCUSD (2017-05 至 2025-10)
- ✅ ETHUSD (2017-12 至 2025-10)
- ✅ EURUSD (2010-01 至 2025-10)
- ✅ USDJPY (2010-01 至 2025-10)
- ✅ XAGUSD (2010-01 至 2025-10)
- ✅ XAUUSD (2010-01 至 2025-10)

### 数据格式
- **文件类型**: Parquet
- **组织方式**: 分区目录 (`symbol=XXX/date=YYYY-MM-DD/*.parquet`)
- **数据列**: `ts`, `symbol`, `bid`, `ask`, `bid_size`, `ask_size`
- **时间戳**: UTC时区，毫秒精度

---

## 🧪 测试结果（BTCUSD, 2020-2025）

### 数据加载
- ✅ 成功加载 **364,466,201** 条tick数据
- ✅ 时间范围: 2020-01-01 至 2025-10-08
- ✅ 数据完整性: 通过
- ✅ 时间戳排序: 正确
- ✅ 去重处理: 完成

### K线构建
- ✅ 生成 **12,174** 个4小时K线
- ✅ OHLCV计算: 正确
- ✅ 成交量聚合: 正确

### OFI因子计算
- ✅ 中间价计算: 正确
- ✅ Tick方向标记: 完成
- ✅ OFI_raw计算: 正确（范围 -0.39 到 +0.41）
- ✅ OFI_z标准化: 完成（覆盖率 98.37%）

### 单因子分析
- ✅ 健全性检查: 通过
- ✅ 条件收益分析: 完成
- ✅ 分位数分析: 完成
- ✅ 统计显著性: 已计算

---

## 📈 关键发现（BTCUSD）

### OFI_z 统计特征
```
样本数:    11,975
均值:       0.017
标准差:     1.054
最小值:    -8.956
最大值:     7.593

分位数:
  10%:     -1.186
  50%:     -0.045
  90%:      1.317
```

### 预测能力（10个K线后的收益）
```
OFI_z分组          平均收益
─────────────────────────────
Bin 1 (最低)       -0.03%
Bin 2              +0.09%
Bin 3 (中性)       +0.22%
Bin 4              +0.30%
Bin 5 (最高)       +0.50%
```

**结论**: OFI_z显示出明显的单调性，高OFI_z（买方压力）对应更高的未来收益。

---

## 🎯 如何使用

### 方法1: 使用现有脚本（推荐）

```bash
# 1. 编辑配置文件，选择品种和日期范围
notepad config\settings.yaml

# 2. 构建K线和OFI
python scripts/build_bars_from_parquet.py

# 3. 运行分析
python scripts/run_ofi_single_factor.py

# 4. 查看结果
type results\sanity\ofi_R0_sanity_BTCUSD.md
```

### 方法2: 自定义分析

参考以下代码：

```python
from src.data.parquet_tick_loader import load_partitioned_parquet_ticks
from src.factors.ofi import add_mid_price, label_tick_directions, compute_ofi_bars

# 加载数据
ticks = load_partitioned_parquet_ticks(
    symbol='BTCUSD',
    ticks_dir=Path('data/ticks'),
    start_date='2024-01-01',
    end_date='2024-12-31'
)

# 计算OFI
ticks = add_mid_price(ticks)
ticks = label_tick_directions(ticks)
ofi_bars = compute_ofi_bars(ticks, bar_size='4H')
```

---

## 📁 生成的文件

### 数据文件
- `results/BTCUSD_4h_bars_with_ofi.csv` - K线+OFI数据

### 分析报告
- `results/sanity/ofi_R0_sanity_BTCUSD.md` - 健全性检查
- `results/single_factor/ofi_R1_single_factor_BTCUSD.csv` - 条件收益
- `results/single_factor/ofi_R1_bins_BTCUSD.csv` - 分位数分析

---

## ⚙️ 配置建议

### 当前配置（`config/settings.yaml`）
```yaml
symbols:
  - BTCUSD  # 已测试通过

data:
  start_date: "2020-01-01"  # 可调整
  end_date: null            # null = 最新

ofi:
  bar_size: "4H"            # 可改为 1H, 2H, 8H, 1D
  zscore_window: 200        # OFI标准化窗口
```

### 建议的下一步
1. **测试其他品种**: 启用 ETHUSD, XAUUSD 等
2. **调整时间范围**: 根据需要修改 start_date/end_date
3. **尝试不同周期**: 测试 1H, 8H, 1D 等K线周期
4. **优化参数**: 调整 zscore_window, horizons 等

---

## 🔧 已创建的工具

### 新增模块
- `src/data/parquet_tick_loader.py` - Parquet数据加载器
- `scripts/build_bars_from_parquet.py` - Parquet数据处理脚本

### 功能特性
- ✅ 自动检测分区结构
- ✅ 支持日期范围过滤
- ✅ 自动数据清洗和去重
- ✅ 时区处理（UTC）
- ✅ 内存优化（按日期分批加载）

---

## 💡 性能参考

### BTCUSD (2020-2025)
- **Tick数据**: 364M 条
- **加载时间**: ~2-3 分钟
- **处理时间**: ~3-5 分钟
- **总耗时**: ~5-10 分钟
- **内存占用**: ~4-8 GB

### 优化建议
- 如果内存不足，缩短日期范围
- 如果处理太慢，增大K线周期
- 批量处理时，一次处理一个品种

---

## 📚 相关文档

- **使用Parquet数据指南.md** - 详细使用说明
- **QUICKSTART.md** - 快速入门
- **README.md** - 项目总览
- **docs/OFI_DESIGN_NOTES.md** - OFI理论设计

---

## ✅ 结论

**您的数据完全可用！**

系统已成功：
1. ✅ 识别并加载Parquet分区数据
2. ✅ 处理3.6亿条tick数据
3. ✅ 生成12,000+个K线
4. ✅ 计算OFI因子
5. ✅ 完成单因子分析
6. ✅ 生成分析报告

**现在您可以：**
- 分析其他品种（ETHUSD, XAUUSD等）
- 调整参数进行更深入的研究
- 基于OFI因子开发交易策略

---

**验证时间**: 2025-11-17  
**验证品种**: BTCUSD  
**数据范围**: 2020-01-01 至 2025-10-08  
**状态**: ✅ 通过

