# 短周期OFI分析 - 说明文档

## ✅ 已完成的工作

### 1. 添加短周期支持

已在配置文件中添加了3个短周期：
- **5分钟** (5min)
- **15分钟** (15min)
- **30分钟** (30min)

### 2. 修改核心函数

更新了 `src/factors/ofi.py` 中的 `compute_ofi_bars` 函数：
- ✅ 现在同时生成 **OHLCV数据** 和 **OFI因子**
- ✅ 支持所有pandas resample频率（5min, 15min, 30min, 1H, 2H, 4H, 8H, 1D等）
- ✅ 输出包含完整的K线数据和OFI指标

### 3. 测试验证

使用BTCUSD 2024年数据进行了测试：

| 周期 | K线数量 | OFI覆盖率 | 测试结果 |
|------|---------|----------|---------|
| 5min | 104,798根 | 99.8% | ✅ 成功 |
| 15min | 34,949根 | 99.4% | ✅ 成功 |
| 30min | 17,479根 | 98.9% | ✅ 成功 |

**测试数据**:
- 品种: BTCUSD
- 时间范围: 2024-01-01 到 2024-12-31
- Tick数量: 57,545,527条
- 总耗时: 32.4秒

---

## 📊 短周期初步结果（BTCUSD 2024）

### 5分钟周期

**条件收益分析**:
| Horizon | OFI组 | 样本数 | 平均收益 | t统计量 |
|---------|-------|--------|----------|---------|
| 2 | 高OFI | 10,460 | +0.0046% | 3.87 |
| 2 | 低OFI | 10,460 | +0.0027% | 1.86 |
| 5 | 高OFI | 10,460 | +0.0137% | 3.87 |
| 5 | 低OFI | 10,460 | +0.0063% | 1.86 |
| 10 | 高OFI | 10,460 | +0.0223% | 4.49 |
| 10 | 低OFI | 10,460 | +0.0090% | 1.90 |

**关键发现**:
- ✅ 5分钟周期OFI因子有效
- ✅ 高OFI组收益显著高于低OFI组
- ✅ t统计量达到3.87-4.49（统计显著）
- ✅ 预测能力随Horizon增加而增强

---

## 🎯 当前配置

### config/settings.yaml

```yaml
bar_settings:
  bar_sizes:
    - "5min"   # 5分钟 ← 新增
    - "15min"  # 15分钟 ← 新增
    - "30min"  # 30分钟 ← 新增
    - "1H"     # 1小时
    - "2H"     # 2小时
    - "4H"     # 4小时
    - "8H"     # 8小时
    - "1D"     # 1天
```

**总周期数**: 8个  
**总配置数**: 6品种 × 8周期 × 3 Horizons = **144个配置**

---

## 🚀 下一步操作

### 选项1: 运行完整批量分析（推荐）

**包含所有周期和全部历史数据**:

```bash
# 使用全部数据（2010-2025）和所有周期（5min到1D）
python scripts/run_full_analysis_all_data.py

# 预计耗时: 5-8小时
# 处理配置: 144个
```

**优点**:
- ✅ 使用全部15年历史数据
- ✅ 包含所有8个时间周期
- ✅ 最全面的分析结果

**缺点**:
- ⏱️ 耗时较长（5-8小时）
- 💾 需要较大内存
- 💾 生成大量文件（~400个）

### 选项2: 分阶段运行

**阶段1: 先运行短周期（5min, 15min, 30min）**

修改 `config/settings.yaml`:
```yaml
bar_settings:
  bar_sizes:
    - "5min"
    - "15min"
    - "30min"
```

运行:
```bash
python scripts/run_full_analysis_all_data.py
```

**阶段2: 再运行长周期（1H, 2H, 4H, 8H, 1D）**

修改配置后再次运行。

### 选项3: 只测试短周期

**快速验证短周期效果**:

```bash
# 只测试BTCUSD的短周期（已完成）
python scripts/test_short_periods.py

# 或测试所有品种的短周期
# 修改config/settings.yaml只保留短周期
python scripts/run_full_analysis_all_data.py
```

---

## 📈 预期结果

### 短周期的特点

**优势**:
- ✅ 更多的样本数量（5min周期可产生10万+K线）
- ✅ 更高的交易频率
- ✅ 更快的信号响应
- ✅ 适合高频交易策略

**挑战**:
- ⚠️ 噪音更多
- ⚠️ 交易成本影响更大
- ⚠️ 需要更快的执行速度
- ⚠️ 可能需要更严格的风险控制

### 预期发现

**可能的结果**:
1. **短周期vs长周期**: 比较不同周期的OFI有效性
2. **最优周期**: 找出每个品种的最佳交易周期
3. **周期组合**: 多周期信号组合策略
4. **市场微结构**: 短周期可能揭示更多市场微结构信息

---

## 📁 生成的文件

### 测试文件（已生成）

```
results/
├── BTCUSD_5min_bars_with_ofi.csv
├── BTCUSD_15min_bars_with_ofi.csv
├── BTCUSD_30min_bars_with_ofi.csv
├── ofi_R0_sanity_BTCUSD_5min.md
├── ofi_R0_sanity_BTCUSD_15min.md
├── ofi_R0_sanity_BTCUSD_30min.md
├── ofi_R1_single_factor_BTCUSD_5min.csv
├── ofi_R1_single_factor_BTCUSD_15min.csv
├── ofi_R1_single_factor_BTCUSD_30min.csv
├── ofi_R1_bins_BTCUSD_5min.csv
├── ofi_R1_bins_BTCUSD_15min.csv
└── ofi_R1_bins_BTCUSD_30min.csv
```

### 完整分析后的文件（预期）

**数据文件**: 48个 (6品种 × 8周期)
**分析报告**: 96个 (48 × 2类型)
**汇总报告**: 2个

**总计**: ~150个文件

---

## 💡 建议

### 立即行动

**推荐方案**: 分两步走

**第1步: 验证短周期（1-2小时）**
```bash
# 修改config/settings.yaml，只保留短周期
bar_sizes:
  - "5min"
  - "15min"
  - "30min"

# 运行分析
python scripts/run_full_analysis_all_data.py
```

**第2步: 完整分析（5-8小时）**
```bash
# 恢复所有周期
bar_sizes:
  - "5min"
  - "15min"
  - "30min"
  - "1H"
  - "2H"
  - "4H"
  - "8H"
  - "1D"

# 运行完整分析
python scripts/run_full_analysis_all_data.py
```

### 数据范围建议

**测试阶段**: 使用2020-2025数据（快速验证）
```yaml
data:
  start_date: "2020-01-01"
  end_date: null
```

**正式分析**: 使用全部历史数据（最终结果）
```yaml
data:
  start_date: null  # 使用全部数据
  end_date: null
```

---

## ✅ 总结

**已完成**:
- ✅ 添加5min, 15min, 30min周期支持
- ✅ 修改核心函数支持OHLCV生成
- ✅ 测试验证短周期功能正常
- ✅ 初步结果显示短周期OFI有效

**待完成**:
- ⏳ 运行所有品种的短周期分析
- ⏳ 运行全部历史数据分析
- ⏳ 生成完整的汇总报告
- ⏳ 对比不同周期的表现

**准备就绪**: 可以开始完整的批量分析！🚀

