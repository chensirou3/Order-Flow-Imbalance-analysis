# OFI Factor Research Project Configuration

# 交易品种列表
symbols:
  - BTCUSD
  - ETHUSD
  - EURUSD
  - USDJPY
  - XAGUSD
  - XAUUSD

# 数据路径配置
data_paths:
  ticks_dir: data/ticks
  bars_dir: data/bars

# 数据过滤（可选）
# 如果不设置，将加载所有可用数据
data:
  start_date: null            # null = 使用全部历史数据
  end_date: null              # null = 到最新数据
  # start_date: "2020-01-01"  # 可选：限制开始日期进行快速测试
  # end_date: "2021-12-31"    # 可选：限制结束日期

# K线设置
bar_settings:
  default_bar_size: "4H"
  # 多时间周期分析
  bar_sizes:
    - "5min"   # 5分钟
    - "15min"  # 15分钟
    - "30min"  # 30分钟
    - "1H"     # 1小时
    - "2H"     # 2小时
    - "4H"     # 4小时
    - "8H"     # 8小时
    - "1D"     # 1天

# OFI因子参数
ofi:
  bar_size: "4H"  # 单次运行使用的周期（被bar_sizes覆盖）
  zscore_window: 200  # OFI标准化的滚动窗口

# 结果输出路径
results_paths:
  bars_with_ofi_dir: results
  sanity_dir: results/sanity
  single_factor_dir: results/single_factor

# 分析参数
analysis:
  horizons: [2, 5, 10]  # 未来收益的时间跨度（以K线数量计）
  quantile_low: 0.10    # OFI_z低分位数阈值
  quantile_high: 0.90   # OFI_z高分位数阈值
  n_bins: 5             # 分位数分析的分组数量

# Phase 4: Trade Path Analysis Configuration
# 只分析加密货币和贵金属（外汇已证明无效）
trade_path_symbols:
  - BTCUSD
  - ETHUSD
  - XAUUSD
  - XAGUSD

# 时间周期（使用简化命名）
timeframes:
  - 5min
  - 15min
  - 30min
  - 1H
  - 2H
  - 4H
  - 8H
  - 1D

# 路径配置
paths:
  results_dir: results
  bars_with_ofi_pattern: "results/{symbol}_{tf}_merged_bars_with_ofi.csv"
  trade_path_dir: results/trade_paths
  trade_summary_dir: results/trade_summaries

# OFI交易路径分析参数
ofi_trade_path:
  # 入场模式: "trend" 或 "reversal"
  # - "trend": Q_high → 做多, Q_low → 做空 (方向 = sign(OFI_z))
  # - "reversal": Q_high → 做空, Q_low → 做多 (方向 = -sign(OFI_z))
  entry_mode: "trend"

  # OFI_z入场分位数阈值
  entry_q_high: 0.8   # 例如: OFI_z >= 80%分位数
  entry_q_low: 0.2    # 例如: OFI_z <= 20%分位数

  # ATR设置（用于R倍数计算）
  atr_period: 20
  atr_method: "rolling_mean"    # 或 "ema" 使用指数移动平均

  # 最大持仓限制（bars）
  hmax_bars: 150

  # 出场规则: 当 loss_in_R <= -MFE_R 或达到 Hmax 时出场
  # MFE_R: Maximum Favorable Excursion in R-multiples
  # 这意味着如果价格从最优点回撤到入场点以下，就出场

  # 是否保存完整的逐bar路径（除了交易摘要）
  save_paths: false

  # 固定仓位大小（名义价值）
  fixed_position_size: 1.0

  # 是否计算并保存详细统计
  compute_detailed_stats: true

# ============================================================================
# Phase 5: Parameter Optimization & Cost Overlay
# ============================================================================
ofi_param_sweep:
  # Which symbol+timeframe pairs to include in Phase 5
  # (start with the top configs from Phase 4, but keep it flexible)
  symbols:
    - BTCUSD
    - ETHUSD

  timeframes:
    - 8H
    - 4H
    - 1D

  # OFI_z entry quantile pairs to test: (q_high, q_low)
  ofi_quantile_sets:
    - [0.80, 0.20]
    - [0.85, 0.15]
    - [0.75, 0.25]

  # Hmax candidates (max holding bars)
  hmax_candidates:
    - 80
    - 100
    - 150

  # Static TP levels in R (optional)
  # null (or 0) means "no TP, use trailing exit only"
  tp_R_levels:
    - null     # no TP
    - 2.0
    - 3.0
    - 4.0

  # Transaction cost scenarios (round-trip costs)
  # cost_rate is a PER-SIDE fraction of price (e.g., 0.00003 = 0.003%)
  # We'll assume two symmetric sides (entry + exit)
  cost_scenarios:
    - name: "low_cost"
      per_side_rate: 0.00003   # 0.003% per side
    - name: "high_cost"
      per_side_rate: 0.0007    # 0.07% per side

  # Where to read base bar+OFI and where to write results
  paths:
    bars_with_ofi_pattern: "results/{symbol}_{tf}_merged_bars_with_ofi.csv"
    sweep_results_dir: "results/param_sweep"

# ============================================================================
# Phase 6: Advanced Analysis & Strategy Spec Generation
# ============================================================================
phase6:
  # 6A: Long vs Short leg decomposition + Regime analysis
  long_short_regime:
    # Which symbol+timeframe pairs to analyze (default = same as Phase 5)
    symbols:
      - BTCUSD
      - ETHUSD
    timeframes:
      - 8H
      - 4H
      - 1D

    # Regime definitions
    trend:
      ma_period: 200              # for close vs MA200 regime
      strong_trend_quantile: 0.7  # trend strength >= 70% quantile
      weak_trend_quantile: 0.3    # trend strength <= 30% quantile

    volatility:
      vol_measure: "atr"          # or "true_range_std"
      high_vol_quantile: 0.7      # volatility >= 70% quantile
      low_vol_quantile: 0.3       # volatility <= 30% quantile

    # Output paths
    paths:
      trade_paths_pattern: "results/trade_paths/individual_trades/{symbol}_{tf}_trades.csv"
      bars_with_ofi_pattern: "results/{symbol}_{tf}_merged_bars_with_ofi.csv"
      long_short_dir: "results/long_short"

  # 6B: OFI × ManipScore joint signal design & diagnostics
  ofi_manipscore_joint:
    # Where to find ManipScore bars
    bars_with_ms_pattern: "results_ms/{symbol}_{tf}_bars_with_manipscore.csv"

    # Where to save joined OFI+MS bars
    bars_with_ofi_ms_pattern: "results_joint/{symbol}_{tf}_bars_with_ofi_ms.csv"

    # OFI_z and ManipScore thresholds for joint signals
    ofi_abs_q: 0.9      # |OFI_z| >= this quantile
    ms_q: 0.9           # ManipScore >= this quantile

    # Timeframes/symbols to try joint signals on
    symbols:
      - BTCUSD
      - ETHUSD
    timeframes:
      - 8H
      - 4H
      - 1D

    # Use best OFI-only config from Phase 5 for simulation parameters
    # (ATR, Hmax, trailing exit logic)
    use_phase5_best_config: true

    # Output paths
    paths:
      bars_with_ofi_pattern: "results/{symbol}_{tf}_merged_bars_with_ofi.csv"
      joint_results_dir: "results/joint"

  # 6C: Strategy Spec generator
  strategy_spec:
    # Top configs to convert into strategy specs
    # (from Phase 5 ranking)
    top_n_per_symbol: 3

    # Input ranking file from Phase 5
    ranking_file: "results/param_sweep/ofi_param_sweep_ranking.csv"

    # Output directory for strategy spec markdown files
    out_dir: "docs/strategy_specs"

    # Ranking criteria (which metric to use for selecting top configs)
    ranking_metric: "mean_final_R_net_high_cost"  # or "sharpe_R_net_high_cost"

    # Include these sections in the strategy spec
    include_sections:
      - overview
      - market_and_timeframe
      - factor_construction
      - entry_rules
      - exit_rules
      - transaction_costs
      - historical_performance
      - notes_and_caveats
